---
title: "EDA"
author: "Kristian Maras"
date: "2024-01-18"
output: html_document
---

## Exploration Data Analysis on S18 Sheep

Load libraries and aggregated data
```{r, results="hide", echo=FALSE}
library(here)
library(tidyverse)
library(stringr)
library(skimr)
source("paths.R")
sheep_name <- "S18"
#get_paths(sheep_name)

aggregate_data <- list.files(path = generated_data_path, 
            pattern = "NestedDataS[0-9]+\\.rds", 
            full.names = TRUE) %>% map(readRDS) %>% bind_rows()


labelled_LongData <- aggregate_data %>% select(-rawsignal, From,To,Animal) %>% unnest(signal)
```

```{r}
#Double check generated data is consistent with data dictionary

aggregate_data %>% filter(sheep == "S18") %>% 
  filter(WaveFront == "SR",Catheter_Type == "Penta", Point_Number == 4815) %>%
  select(signal) %>%
  unlist() %>%
  plot(type = "l")

```


High level split of data TODO.

```{r}
#TODO
 aggregate_data %>% select(across(where(is.numeric))) %>% skim(.)

```

Count of Scar and no Scar by category. Control sheep S17 still has scar labels - investigate.
```{r}
aggregate_data %>% filter(!is.null(signal)) %>% group_by(sheep,Catheter_Type,WaveFront,Categorical_Label) %>% 
  summarise(n = n()) 


```

 Fix the below to use aggregate_data now and some plots!! TODO
 
 
Distribution of signal length. 
```{r}

summary_signals <- aggregate_data %>% group_by(WaveFront, Catheter_Type, Point_Number) %>%  summarise(n = n()) %>% arrange(n)
summary_signals
```

Lets investigate the distribution of signals and see what influences the scar / no scar category.

```{r}
labelled_LongData <- labelled_LongData %>% group_by(Point_Number,WaveFront, Catheter_Type) %>% mutate(Row = row_number()) %>% ungroup()


```

What do the signals look like?

```{r}
p <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~Categorical_Label) 
  
  
```

To do Scatter with all data - is there a relationship with Point numbers or location.
```{r}

p <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Point_Number,y = ~signal_data, type = 'scatter', mode = 'markers',
  color = ~Categorical_Label) 


```

RvP has signals of more duration, especially compared to LvP. 
Possible outlier with a LVP datapoint.


```{r}


 
q <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~WaveFront) 
  

q

```
Relationship between regions in space

```{r}
spatial_data <- LabelledSignalData %>% mutate(distance = sqrt(X**2 + Y**2 + Z**2)) %>% 
  select(distance,Histology_Biopsy_Label) %>% 
  na.omit() %>% filter(Histology_Biopsy_Label != "no scar") %>% 
  filter(Histology_Biopsy_Label != "no_scar")

spatial_data %>% select(Histology_Biopsy_Label) %>% unique()

```
to be continued - slow to render...

```{r}
#g <- labelled_LongData %>%  ggplot(aes(x = Row, y = signal_data, color = Categorical_Label)) +
#  geom_point() + 
#  facet_wrap(vars(WaveFront),nrow = 3, ncol = 1)

#ggplotly(g)



```



