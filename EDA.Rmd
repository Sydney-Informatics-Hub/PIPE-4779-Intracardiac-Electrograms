---
title: "EDA"
author: "Kristian Maras"
date: "2024-01-18"
output: html_document
---

## Exploration Data Analysis on S18 Sheep

Load libraries and aggregated data
```{r echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
library(here)
library(tidyverse)
library(stringr)
library(skimr)
library(plotly)
library(RColorBrewer)
source("paths.R")
get_paths()

aggregate_data <- list.files(path = generated_data_path, 
            pattern = "NestedDataS[0-9]+\\.rds", 
            full.names = TRUE) %>% map(readRDS) %>% bind_rows()


```

Imputed data includes the signals that were grossly assumed to be no scar
without magnification. 
```{r}
imputed_aggregate_data <- aggregate_data %>% filter(!is.null(signal)) %>% 
  mutate(endocardium_scar = ifelse(is.na(endocardium_scar),0,endocardium_scar),
         intramural_scar = ifelse(is.na(intramural_scar),0,intramural_scar),
         epicardial_scar = ifelse(is.na(epicardial_scar),0,epicardial_scar))
```

Will refer to a Scar based on the biopsy layers as indication of scar
```{r}

aggregate_data <- aggregate_data %>% mutate(AnyScar = sum(endocardium_scar + intramural_scar + epicardial_scar)) %>%
  mutate(Categorical_Label = case_when(
    is.na(AnyScar) ~ NA_character_,
    AnyScar >= 1 ~ "Scar",
    AnyScar == 0 ~ "NoScar"
  ))
  
imputed_aggregate_data <- imputed_aggregate_data %>% mutate(AnyScar = sum(endocardium_scar + intramural_scar + epicardial_scar)) %>%
  mutate(Categorical_Label = case_when(
    is.na(AnyScar) ~ NA_character_,
    AnyScar >= 1 ~ "Scar",
    AnyScar == 0 ~ "NoScar"
  ))
  

```

Setting up data for rest of EDA
building_features.R uses this data
```{r}
cleaned_aggregate_data <- aggregate_data %>% filter(!is.null(signal)) %>% 
  filter(!is.na(endocardium_scar))

#

saveRDS(cleaned_aggregate_data,file = here::here(generated_data_path,"filtered_aggregate_data.rds"))

saveRDS(imputed_aggregate_data,file = here::here(generated_data_path,"imputed_aggregate_data.rds"))

cleaned_aggregate_long_data <- cleaned_aggregate_data %>% select(-rawsignal, -From,-To,-Animal) %>% unnest(signal)
cleaned_aggregate_long_data <- cleaned_aggregate_long_data %>% group_by(sheep,Point_Number,WaveFront, Catheter_Type) %>% mutate(Row = row_number()) %>% ungroup()

saveRDS(cleaned_aggregate_long_data,file = here::here(generated_data_path,"cleaned_aggregate_long_data.rds"))

```

```{r}
#Double check generated data is consistent with data dictionary

aggregate_data %>% filter(sheep == "S18") %>% 
  filter(WaveFront == "SR",Catheter_Type == "Penta", Point_Number == 4815) %>%
  select(signal) %>%
  unlist() %>%
  plot(type = "l")

```

Coincidently, the raw data looks like
```{r}

aggregate_data %>% filter(sheep == "S18") %>% 
  filter(WaveFront == "SR",Catheter_Type == "Penta", Point_Number == 4815) %>%
  select(rawsignal) %>%
  unlist() %>%
  plot(type = "l")

```

High level split of count of observations with and without histology info. Note - The histology data is sometimes blank and a signal is sometimes not present. Generally
the number of observations that have histology labels (0 or 1) are outnumber by those that dont, particularly with S20.

```{r paged.print=FALSE}
aggregate_data %>% group_by(sheep,Catheter_Type,WaveFront) %>% 
  summarise(histology_count = sum(!is.na(endocardium_scar)),
            no_histology_count = sum(is.na(endocardium_scar))) %>% 
  arrange(sheep,desc(histology_count))

```



The available data reduces as not all data points have signal info along 
with not all points having histology info (blanks in cleaned_histology_all file).

23K of points is reduced to 6.7K. Of these points, 4K have been labelled as Scar

What this means is the pool of data that can be fed into machine learning signficantly decreases.
```{r}
aggregate_data %>% filter(!is.null(signal)) %>% count(Categorical_Label)

```


Verify S20 is the control 
```{r}
aggregate_data %>% filter(!is.null(signal)) %>% group_by(sheep) %>% count(Categorical_Label)

```

Same thing but by group
```{r}

aggregate_data %>% filter(!is.null(signal)) %>% group_by(sheep,Catheter_Type,WaveFront) %>% 
  count(Categorical_Label)


```

 
 
 
Distribution of signal length assuming there is a signal. Reflects manual calibration 
of starting point for window of interest.
```{r}

summary_window_length <- aggregate_data %>% 
  mutate(length_window = To - From) %>% filter(length_window != 0) %>% 
  group_by(WaveFront, Categorical_Label) %>% select(length_window) 
  

summary_window_length %>%
  plot_ly(x = ~length_window, type = "histogram") %>%
  layout(barmode = "overlay", 
         xaxis = list(title = "Window of interest lenth"),
         yaxis = list(title = "Frequency"),
         title = "Histogram of Distinct Windows of Interest",
         facet_row = ~WaveFront,
         facet_col = ~Categorical_Label)
```

Shows distinct windows of interest by sheep.

```{r}

 aggregate_data %>% filter(!is.na(Categorical_Label)) %>% 
   mutate(length_window = To - From) %>% group_by(sheep) %>% filter(length_window != 0) %>% 
  summarise(mean_window = mean(length_window,na.rm = T))

```

```{r}

 aggregate_data %>% filter(!is.na(Categorical_Label)) %>% 
   mutate(length_window = To - From) %>% group_by(sheep) %>%  distinct(length_window) %>% 
  arrange(sheep,length_window) 

```


What do the signals look like? 
Scar versus No Scar

```{r}
# Define a color palette
colors <- brewer.pal(n = 2, name = "Set1") 


p <- cleaned_aggregate_long_data %>% select(Categorical_Label,signal_data,Row,sheep,WaveFront, Catheter_Type, Point_Number) %>% 
  group_by(sheep,WaveFront, Catheter_Type, Point_Number) %>%
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~Categorical_Label, colors = colors, line = list(width = 0.5),opacity = 0.8) 
  
#p
```


What do the signals look like? 
WaveFronts
```{r}
colors <- brewer.pal(n = 3, name = "Set3") 

p <- cleaned_aggregate_long_data %>% select(Categorical_Label,signal_data,Row,sheep,WaveFront, Catheter_Type, Point_Number) %>% 
  group_by(sheep,WaveFront, Catheter_Type, Point_Number) %>%
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~WaveFront, line = list(width = 0.5),
  colors = colors) 
  
#p
```

What do the signals look like? 
Sheep

```{r}


colors <- brewer.pal(n = 4, name = "Set3") 

p <- cleaned_aggregate_long_data %>% select(Categorical_Label,signal_data,Row,sheep,WaveFront, Catheter_Type, Point_Number) %>% 
  group_by(sheep,WaveFront, Catheter_Type, Point_Number) %>%
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~sheep, line = list(width = 0.5),
  colors = colors) 
  
#p
```

To Investigate a particular sheep, Choose Sheep and WaveFront to drill down to look at Scar v No Scar
S20 SR - No scar seems more eratic 
S18 SR - The typical profile
S17 SR - The typical profile**

```{r}
# WaveFronts: "LVp" "RVp" "SR"
# sheep: S18 S12 S17 S20
select_sheep <- "S18"
select_wavefront <- "SR"
colors <- brewer.pal(n = 4, name = "Set3") 

p <- cleaned_aggregate_long_data %>% select(Categorical_Label,signal_data,Row,sheep,WaveFront, Catheter_Type, Point_Number) %>% 
  filter(sheep == select_sheep,WaveFront == select_wavefront) %>% 
  group_by(sheep,WaveFront, Catheter_Type, Point_Number) %>%
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~Categorical_Label, line = list(width = 0.5),
  colors = colors)  %>% 
  layout( 
         xaxis = list(title = "Row"),
         yaxis = list(title = "signal"),
         title = paste0(select_sheep," signals"))
  
#p
```

