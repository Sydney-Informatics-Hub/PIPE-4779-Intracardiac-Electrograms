---
title: "EDA"
author: "Kristian Maras"
date: "2024-01-18"
output: html_document
---

## Exploration Data Analysis on S18 Sheep

Load libraries and aggregated data
```{r, results="hide", echo=FALSE}
library(here)
library(tidyverse)
library(stringr)
source("paths.R")
LabelledSignalData <- readRDS(file = here::here(generated_data_path,"LabelledSignalDataS18.rds"))
labelled_LongData <- LabelledSignalData %>% unnest(signal)
```

```{r}
#Double check generated data is consistent with data dictionary
LabelledSignalData <- readRDS(file = here::here(generated_data_path,"LabelledSignalDataS18.rds"))

LabelledSignalData %>%
  filter(WaveFront == "SR",Catheter_Type == "Penta", Point_Number == 4815) %>%
  select(signal) %>%
  unlist() %>%
  plot(type = "l")

```

Most regions only have 1 or 2 types of measurements, not all 3 ( RVp, LVp, SR).

```{r}
data <- tibble(files = list.files(path = here::here("data","S18","Export_Analysis-01_05_2024-17-02-34"),
                                  pattern = "*.xml"))


files_and_regions <- data %>% filter(str_detect(files,pattern = "Penta.*Export")) %>% 
  mutate(region =  str_extract(files, "_P(\\d+)_") %>% gsub("_", "",.), 
         number = as.numeric(gsub("P","",region))) %>% arrange(number)

number_regions <- files_and_regions %>% distinct(region) %>% count()

```


Signal length varies. 
```{r}

summary_signals <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>%  summarise(n = n()) %>% arrange(n)
summary_signals
```

Lets investigate the distribution of signals and see what influences the scar / no scar category.

```{r}
labelled_LongData <- labelled_LongData %>% group_by(Point_Number,WaveFront, Catheter_Type) %>% mutate(Row = row_number()) %>% ungroup()


```

What do the signals look like?

```{r}
p <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~Categorical_Label) 
  
  
```

To do Scatter with all data - is there a relationship with Point numbers or location.
```{r}

p <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Point_Number,y = ~signal_data, type = 'scatter', mode = 'markers',
  color = ~Categorical_Label) 


```

RvP has signals of more duration, especially compared to LvP. 
Possible outlier with a LVP datapoint.


```{r}


 
q <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~WaveFront) 
  

q

```
Relationship between regions in space

```{r}
spatial_data <- LabelledSignalData %>% mutate(distance = sqrt(X**2 + Y**2 + Z**2)) %>% 
  select(distance,Histology_Biopsy_Label) %>% 
  na.omit() %>% filter(Histology_Biopsy_Label != "no scar") %>% 
  filter(Histology_Biopsy_Label != "no_scar")

spatial_data %>% select(Histology_Biopsy_Label) %>% unique()

```
to be continued - slow to render...

```{r}
#g <- labelled_LongData %>%  ggplot(aes(x = Row, y = signal_data, color = Categorical_Label)) +
#  geom_point() + 
#  facet_wrap(vars(WaveFront),nrow = 3, ncol = 1)

#ggplotly(g)



```



