---
title: "EDA"
author: "Kristian Maras"
date: "2024-01-18"
output: html_document
---

## Exploration Data Analysis on S18 Sheep

Load libraries and aggregated data
```{r, results="hide", echo=FALSE}
library(here)
library(tidyverse)
library(stringr)
library(skimr)
library(plotly)
library(RColorBrewer)
source("paths.R")
get_paths()

aggregate_data <- list.files(path = generated_data_path, 
            pattern = "NestedDataS[0-9]+\\.rds", 
            full.names = TRUE) %>% map(readRDS) %>% bind_rows()


```

Seems to be Scar label where the 3 layers are all zero indicating inconsistency. 
Affects 3 out of 17 thousand observations. Suspect Scar label to be misleading and Scar will be defined by biopsy layers.

```{r}

inconsistency <- aggregate_data %>% mutate(AnyScar = sum(endocardium_scar + intramural_scar + epicardial_scar)) %>% filter(Categorical_Label == "Scar" & AnyScar == 0) 
```


Note Done: Hence will refer to a Scar based on the biopsy layers
```{r}

aggregate_data <- aggregate_data %>% mutate(AnyScar = sum(endocardium_scar + intramural_scar + epicardial_scar)) %>%
  mutate(Categorical_Label = case_when(
    is.na(AnyScar) ~ NA_character_,
    AnyScar >= 1 ~ "Scar",
    AnyScar == 0 ~ "NoScar"
  ))
  
  

```

Setting up data for rest of EDA.
```{r}
cleaned_aggregate_data <- aggregate_data %>% filter(!is.null(signal)) %>% 
  filter(!is.na(endocardium_scar))

saveRDS(cleaned_aggregate_data,file = here::here(generated_data_path,"cleaned_aggregate_data.rds"))

cleaned_aggregate_long_data <- cleaned_aggregate_data %>% select(-rawsignal, -From,-To,-Animal) %>% unnest(signal)

saveRDS(cleaned_aggregate_long_data,file = here::here(generated_data_path,"cleaned_aggregate_long_data.rds"))

```

```{r}
#Double check generated data is consistent with data dictionary

aggregate_data %>% filter(sheep == "S18") %>% 
  filter(WaveFront == "SR",Catheter_Type == "Penta", Point_Number == 4815) %>%
  select(signal) %>%
  unlist() %>%
  plot(type = "l")

```

Coincidently, the raw data looks like
```{r}

aggregate_data %>% filter(sheep == "S18") %>% 
  filter(WaveFront == "SR",Catheter_Type == "Penta", Point_Number == 4815) %>%
  select(rawsignal) %>%
  unlist() %>%
  plot(type = "l")

```

High level split of count of observations with and without histology info. Note - The histology data is sometimes blank and a signal is sometimes not present. Generally
the number of observations that have histology labels (0 or 1) are outnumber by those that dont, particularly with S20.

```{r}
aggregate_data %>% group_by(sheep,Catheter_Type,WaveFront) %>% 
  summarise(histology_count = sum(!is.na(endocardium_scar)),
            no_histology_count = sum(is.na(endocardium_scar))) %>% 
  arrange(sheep,desc(histology_count))

```



The available data reduces as not all data points have signal info. 
The proportion of Scar data outweights noScar data.

What this means is the pool of data that can be fed into machine learning signficantly decreases.
```{r}
aggregate_data %>% filter(!is.null(signal)) %>% count(Categorical_Label)

```

Same thing but by group
```{r}

aggregate_data %>% filter(!is.null(signal)) %>% group_by(sheep,Catheter_Type,WaveFront) %>% 
  count(Categorical_Label)


```

 
 
 
Distribution of signal length assuming there is a signal. Reflects manual calibration 
of starting point for window of interest.
```{r}

summary_window_length <- aggregate_data %>% 
  mutate(length_window = To - From) %>% filter(length_window != 0) %>% 
  group_by(WaveFront, Categorical_Label) %>% select(length_window) 
  

summary_window_length %>%
  plot_ly(x = ~length_window, type = "histogram") %>%
  layout(barmode = "overlay", 
         xaxis = list(title = "Variable to Plot"),
         yaxis = list(title = "Frequency"),
         title = "Histogram by Factor1 and Factor2",
         facet_row = ~WaveFront,
         facet_col = ~Categorical_Label)
```

Shows distinct windows of interest by sheep.
```{r}

 aggregate_data %>% filter(!is.na(Categorical_Label)) %>% 
   mutate(length_window = To - From) %>% group_by(sheep) %>%  distinct(length_window) %>% 
  arrange(sheep,length_window)

```

Lets visualise signals and see what influences the scar / no scar category. 
From here I'm working with the cleaned data (where there is a signal and histology is 0 or 1)

```{r}
cleaned_aggregate_long_data <- cleaned_aggregate_long_data %>% group_by(sheep,Point_Number,WaveFront, Catheter_Type) %>% mutate(Row = row_number()) %>% ungroup()


```


What do the signals look like? 
Scar versus No Scar

```{r}
# Define a color palette
colors <- brewer.pal(n = 2, name = "Set1") 


p <- cleaned_aggregate_long_data %>% select(Categorical_Label,signal_data,Row,sheep,WaveFront, Catheter_Type, Point_Number) %>% 
  group_by(sheep,WaveFront, Catheter_Type, Point_Number) %>%
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~Categorical_Label, colors = colors, line = list(width = 0.5),opacity = 0.8) 
  
#p
```


What do the signals look like? 
WaveFronts
```{r}
colors <- brewer.pal(n = 3, name = "Set3") 

p <- cleaned_aggregate_long_data %>% select(Categorical_Label,signal_data,Row,sheep,WaveFront, Catheter_Type, Point_Number) %>% 
  group_by(sheep,WaveFront, Catheter_Type, Point_Number) %>%
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~WaveFront, line = list(width = 0.5),
  colors = colors) 
  
#p
```

What do the signals look like? 
Sheep

```{r}


colors <- brewer.pal(n = 4, name = "Set3") 

p <- cleaned_aggregate_long_data %>% select(Categorical_Label,signal_data,Row,sheep,WaveFront, Catheter_Type, Point_Number) %>% 
  group_by(sheep,WaveFront, Catheter_Type, Point_Number) %>%
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~sheep, line = list(width = 0.5),
  colors = colors) 
  
#p
```

Choose Sheep and WaveFront to drill down to look at Scar v No Scar

```{r}
# WaveFronts: "LVp" "RVp" "SR"
select_sheep <- "S18"
select_wavefront <- "LVp"
colors <- brewer.pal(n = 4, name = "Set3") 

p <- cleaned_aggregate_long_data %>% select(Categorical_Label,signal_data,Row,sheep,WaveFront, Catheter_Type, Point_Number) %>% 
  filter(sheep == select_sheep,WaveFront == select_wavefront) %>% 
  group_by(sheep,WaveFront, Catheter_Type, Point_Number) %>%
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~Categorical_Label, line = list(width = 0.5),
  colors = colors) 
  
#p
```

