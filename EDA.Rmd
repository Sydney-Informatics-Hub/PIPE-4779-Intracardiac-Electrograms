---
title: "EDA"
author: "Kristian Maras"
date: "2024-01-18"
output: html_document
---

## Exploration Data Analysis on S18 Sheep

Load libraries and aggregated data
```{r, results="hide", echo=FALSE}
library(here)
library(tidyverse)
library(stringr)
library(skimr)
library(plotly)
source("paths.R")
sheep_name <- "S18"
get_paths(sheep_name)

aggregate_data <- list.files(path = generated_data_path, 
            pattern = "NestedDataS[0-9]+\\.rds", 
            full.names = TRUE) %>% map(readRDS) %>% bind_rows()


```

Seems to be Scar label where the 3 layers are all zero indicating inconsistency. 
Affects 3 out of 17 thousand observations.

```{r}

inconsistency <- aggregate_data %>% mutate(AnyScar = sum(endocardium_scar + intramural_scar + epicardial_scar)) %>% filter(Categorical_Label == "Scar" & AnyScar == 0) 
```


Hence will refer to a Scar based on the biopsy layers
```{r}

#aggregate_data <- aggregate_data %>% mutate(AnyScar = sum(endocardium_scar + intramural_scar + epicardial_scar)) %>% mutate(Categorical_Label = ifelse(AnyScar >= 1,"Scar","NoScar"))
```

Setting up data for rest of EDA.
```{r}
cleaned_aggregate_data <- aggregate_data %>% filter(!is.null(signal)) %>% 
  filter(!is.na(endocardium_scar))
cleaned_aggregate_long_data <- cleaned_aggregate_data %>% select(-rawsignal, -From,-To,-Animal) %>% unnest(signal)

```

```{r}
#Double check generated data is consistent with data dictionary

aggregate_data %>% filter(sheep == "S18") %>% 
  filter(WaveFront == "SR",Catheter_Type == "Penta", Point_Number == 4815) %>%
  select(signal) %>%
  unlist() %>%
  plot(type = "l")

```

Coincidently, the raw data looks like
```{r}

aggregate_data %>% filter(sheep == "S18") %>% 
  filter(WaveFront == "SR",Catheter_Type == "Penta", Point_Number == 4815) %>%
  select(rawsignal) %>%
  unlist() %>%
  plot(type = "l")

```

High level split of count of observations with and without histology info. The histology data is sometimes blank and a signal is sometimes not present. Generally
the number of observations that have histology labels (0 or 1) are outnumber by those that dont, particularly with S20.

```{r}
aggregate_data %>% group_by(sheep,Catheter_Type,WaveFront) %>% 
  summarise(histology_count = sum(!is.na(endocardium_scar)),
            no_histology_count = sum(is.na(endocardium_scar))) %>% 
  arrange(sheep,desc(histology_count))

```


Count of Scar and no Scar by category. 
Control sheep S17 still has scar labels - investigate.
```{r}

aggregate_data %>% filter(!is.null(signal)) %>% group_by(sheep,Catheter_Type,WaveFront) %>% 
  summarise(scar = sum((Categorical_Label == "Scar")),
            NoScar = sum(Categorical_Label == "NoScar")) 


```

 
 
 
Distribution of signal length assuming there is a signal. Reflects manual calibration 
of starting point for window of interest.
```{r}

summary_window_length <- aggregate_data %>% 
  mutate(length_window = To - From) %>% filter(length_window != 0) %>% 
  group_by(WaveFront, Categorical_Label) %>% select(length_window) 
  

summary_window_length %>%
  plot_ly(x = ~length_window, type = "histogram") %>%
  layout(barmode = "overlay", 
         xaxis = list(title = "Variable to Plot"),
         yaxis = list(title = "Frequency"),
         title = "Histogram by Factor1 and Factor2",
         facet_row = ~WaveFront,
         facet_col = ~Categorical_Label)
```



Lets investigate the distribution of signals and see what influences the scar / no scar category. HERE - Looks ODD! 

```{r}
cleaned_aggregate_long_data <- cleaned_aggregate_long_data %>% group_by(Point_Number,WaveFront, Catheter_Type) %>% mutate(Row = row_number()) %>% ungroup()


```

What do the signals look like?

```{r}
p <- cleaned_aggregate_long_data %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~Categorical_Label) 
  
  
```

To do Scatter with all data - is there a relationship with Point numbers or location.
```{r}

p <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Point_Number,y = ~signal_data, type = 'scatter', mode = 'markers',
  color = ~Categorical_Label) 


```

RvP has signals of more duration, especially compared to LvP. 
Possible outlier with a LVP datapoint.


```{r}


 
q <- labelled_LongData %>% group_by(WaveFront, Catheter_Type, Point_Number) %>% 
  plot_ly(., x = ~Row,y = ~signal_data, type = 'scatter', mode = 'lines',
  color = ~WaveFront) 
  

q

```
Relationship between regions in space

```{r}
spatial_data <- LabelledSignalData %>% mutate(distance = sqrt(X**2 + Y**2 + Z**2)) %>% 
  select(distance,Histology_Biopsy_Label) %>% 
  na.omit() %>% filter(Histology_Biopsy_Label != "no scar") %>% 
  filter(Histology_Biopsy_Label != "no_scar")

spatial_data %>% select(Histology_Biopsy_Label) %>% unique()

```
to be continued - slow to render...

```{r}
#g <- labelled_LongData %>%  ggplot(aes(x = Row, y = signal_data, color = Categorical_Label)) +
#  geom_point() + 
#  facet_wrap(vars(WaveFront),nrow = 3, ncol = 1)

#ggplotly(g)



```



